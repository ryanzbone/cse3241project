SELECT DISTINCT B.title,
                N.lname
FROM   book B,
       bookauthor A,
       names N
WHERE  b.price < 10.00
       AND A.nameid = N.id
       AND N.lname LIKE '%Pratchett'
       AND B.isbn = A.isbn;

SELECT B.title,
       T.timestamp
FROM   book B,
       monetarytransaction T,
       customerorder O,
       ordercontents G
WHERE  T.oid = O.id
       AND G.oid = O.id
       AND B.isbn = G.bid
       AND T.epayer = 121;

SELECT B.title,
       B.isbn,
       I.quantity
FROM   book B,
       inventory I
WHERE  I.bid = B.isbn
       AND i.quantity < 5;

SELECT N.fname,
       N.mname,
       N.lname,
       B.title
FROM   entity E,
       names N,
       customer C,
       monetarytransaction T,
       customerorder O,
       ordercontents G,
       book B,
       bookauthor A
WHERE  C.eid = T.epayer
       AND T.oid = O.id
       AND C.eid = E.id
       AND G.oid = O.id
       AND B.isbn = G.bid
       AND A.isbn = B.isbn
       AND E.nameid = N.id
       AND N.lname LIKE '%Pratchett';

SELECT Sum(quantity)
FROM   monetarytransaction T,
       customerorder O,
       ordercontents G
WHERE  T.epayer = 140
       AND T.id = O.transactionid
       AND G.oid = O.id;

ELECT EidSum.eid,
       EidSum.total
FROM   (SELECT C.eid,
               Sum(quantity) AS total
        FROM   customer C,
               monetarytransaction T,
               customerorder O,
               ordercontents G
        WHERE  C.eid = T.epayer
               AND T.oid = O.id
               AND G.oid = O.id
        GROUP  BY C.eid) EidSum
WHERE  EidSum.total = (SELECT Max(e.total)
                       FROM   (SELECT Sum(quantity) AS total
                               FROM   customer C,
                                      monetarytransaction T,
                                      customerorder O,
                                      ordercontents G
                               WHERE  C.eid = T.epayer
                                      AND T.oid = O.id
                                      AND G.oid = O.id
                               GROUP  BY C.eid) e);

SELECT Sum(I.quantity)
FROM   book B,
       bookauthor A,
       names N,
       inventory I
WHERE  B.isbn = A.isbn
       AND I.bid = B.isbn
       AND A.nameid = N.id
       AND N.lname LIKE '%Pratchett';

SELECT Avg(rating)
FROM   rating
WHERE  bid = 140077022;

SELECT Avg(r.rating)
FROM   rating r
       JOIN book b
         ON r.bid = b.isbn
WHERE  r.bid = 140077022;

SELECT Max(salary)
FROM   employee AS E
       JOIN (SELECT emanager AS manager
             FROM   employee E,
                    entity N
             WHERE  E.eid = E.emanager
                    AND emanager IS NOT NULL) AS M
         ON E.eid = M.manager
WHERE  E.salary IS NOT NULL;

SELECT N.fname,
       N.mname,
       N.lname,
       Sum(amount)
FROM   customer C,
       names N,
       entity E,
       monetarytransaction T
WHERE  E.id = C.eid
       AND T.epayer = C.eid
       AND N.id = E.nameid
GROUP  BY C.eid;

SELECT N.fname,
       N.mname,
       N.lname,
       E.email
FROM   monetarytransaction T,
       entity E,
       names N
WHERE  t.epayer = E.id
       AND E.nameid = N.id
GROUP  BY T.epayer
HAVING T.amount > (SELECT Avg (amount)
                   FROM   monetarytransaction);

SELECT B.title,
       Sum(quantity)
FROM   book AS B,
       customerorder AS O,
       ordercontents AS G
WHERE  G.oid = O.id
       AND G.bid = B.isbn
GROUP  BY B.isbn
ORDER  BY Sum(quantity) DESC;

SELECT B.title,
       B.price * Sum(G.quantity) AS total
FROM   customer AS C,
       monetarytransaction AS T,
       book AS B,
       customerorder AS O,
       ordercontents AS G
WHERE  T.epayer = C.eid
       AND T.oid = O.id
       AND G.oid = O.id
       AND B.isbn = G.bid
GROUP  BY B.isbn
ORDER  BY total DESC;

ELECT D.fname,
       D.mname,
       D.lname
FROM   (SELECT N.id,
               N.fname,
               N.mname,
               N.lname,
               Sum(quantity) AS sales
        FROM   customer C,
               customerorder O,
               ordercontents G,
               book B,
               bookauthor A,
               names N
        WHERE  O.eto = C.eid
               AND G.oid = O.id
               AND B.isbn = G.bid
               AND B.isbn = A.isbn
               AND A.nameid = N.id
        GROUP  BY N.id) AS D
GROUP  BY D.id
HAVING D.sales = Max(D.sales)
LIMIT  1;


SELECT D.id,
       Max(D.money)
FROM   (SELECT F.id,
               F.price * Sum(total) AS money
        FROM   (SELECT N.id,
                       B.price,
                       Sum(quantity) AS total
                FROM   customer C,
                       customerorder O,
                       ordercontents G,
                       book B,
                       bookauthor A,
                       names N
                WHERE  O.eto = C.eid
                       AND G.oid = O.id
                       AND B.isbn = G.bid
                       AND A.isbn = B.isbn
                       AND A.nameid = N.id
                GROUP  BY B.isbn) AS F
        GROUP  BY F.id) AS D

SELECT DISTINCT E.*
FROM   customer AS C,
       entity AS E,
       customerorder AS O,
       ordercontents AS G,
       book AS B,
       bookauthor A,
       (SELECT nameid,
               Max(money)
        FROM   (SELECT F.nameid,
                       F.price * Sum(total) AS money
                FROM   (SELECT A.nameid,
                               B.price,
                               Sum(quantity) AS total
                        FROM   customer AS C,
                               customerorder AS O,
                               ordercontents AS G,
                               book AS B,
                               bookauthor A
                        WHERE  O.eto = C.eid
                               AND G.oid = O.id
                               AND B.isbn = G.bid
                               AND B.isbn = A.isbn
                        GROUP  BY B.isbn) AS F
                GROUP  BY F.nameid) AS D) AS J
WHERE  C.eid = O.eto
       AND C.eid = E.id
       AND G.oid = O.id
       AND G.bid = B.isbn
       AND B.isbn = A.isbn
       AND A.nameid = J.nameid;
